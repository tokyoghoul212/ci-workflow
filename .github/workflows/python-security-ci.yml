# name: Python Security CI

# on:
#   workflow_call:
#     inputs:
#       run_tests:
#         description: "Run unit tests"
#         required: false
#         default: true
#         type: boolean
#       run_sonar:
#         description: "Run SonarQube scan"
#         required: false
#         default: true
#         type: boolean
#       run_snyk:
#         description: "Run Snyk scan"
#         required: false
#         default: true
#         type: boolean
#     secrets:
#       SONAR_TOKEN:
#         description: "Token for SonarQube / SonarCloud analysis"
#         required: false
#       SNYK_TOKEN:
#         description: "Snyk API token"
#         required: false

# jobs:
#   tests:
#     if: ${{ inputs.run_tests }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install Python dependencies
#         run: |
#           python -m pip install --upgrade pip
#           python -m pip install -r requirements.txt

#       - name: Run tests
#         env:
#           PYTHONPATH: .
#         run: |
#           python -m pytest

#   sonar:
#     if: ${{ inputs.run_sonar }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Check SONAR_TOKEN is passed
#         run: |
#           if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
#             echo "SONAR_TOKEN was not passed from caller workflow."
#             exit 1
#           fi

#       - name: SonarQube Cloud Scan
#         uses: SonarSource/sonarqube-scan-action@v6
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

#   snyk:
#     if: ${{ inputs.run_snyk }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install Python dependencies
#         run: |
#           python -m pip install --upgrade pip
#           python -m pip install -r requirements.txt

#       - name: Set up Node.js for Snyk CLI
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"

#       - name: Install Snyk CLI
#         run: npm install -g snyk

#       - name: Snyk auth
#         env:
#           SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
#         run: |
#           if [ -z "$SNYK_TOKEN" ]; then
#             echo "SNYK_TOKEN is NOT set. Please pass it from the caller workflow."
#             exit 1
#           fi
#           snyk auth "$SNYK_TOKEN"

#       - name: Run Snyk test (Python deps)
#         run: |
#           snyk test --severity-threshold=low

name: Python Security CI (Reusable)

on:
  workflow_call:
    inputs:
      python_version:
        description: "Python version to use"
        required: false
        type: string
        default: "3.12"

      working_directory:
        description: "Directory to run commands in"
        required: false
        type: string
        default: "."

      requirements_file:
        description: "Requirements file path (relative to working_directory)"
        required: false
        type: string
        default: "requirements.txt"

      run_tests:
        description: "Run pytest"
        required: false
        type: boolean
        default: true

      test_command:
        description: "Test command to run"
        required: false
        type: string
        default: "pytest -q"

      run_sonar:
        description: "Run SonarQube scan"
        required: false
        type: boolean
        default: false

      sonar_args:
        description: "Extra Sonar scanner args (optional)"
        required: false
        type: string
        default: ""

      run_snyk:
        description: "Run Snyk (Open Source dependency scan)"
        required: false
        type: boolean
        default: false

      snyk_args:
        description: "Extra Snyk args (optional)"
        required: false
        type: string
        default: "--severity-threshold=high"

    secrets:
      SONAR_TOKEN:
        required: false
      SNYK_TOKEN:
        required: false

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    # Put secrets into env so step-level if can safely check env.*
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: pip
          cache-dependency-path: ${{ inputs.working_directory }}/${{ inputs.requirements_file }}

      - name: Install dependencies
        working-directory: ${{ inputs.working_directory }}
        run: |
          python -m pip install --upgrade pip
          if [ -f "${{ inputs.requirements_file }}" ]; then
            pip install -r "${{ inputs.requirements_file }}"
          else
            echo "requirements file not found: ${{ inputs.requirements_file }} (skipping install)"
          fi

      - name: Run tests
        if: ${{ inputs.run_tests }}
        working-directory: ${{ inputs.working_directory }}
        run: ${{ inputs.test_command }}

      - name: SonarQube Scan (Server/Cloud)
        if: ${{ inputs.run_sonar && env.SONAR_TOKEN != '' }}
        uses: SonarSource/sonarqube-scan-action@v7
        with:
          projectBaseDir: ${{ inputs.working_directory }}
          args: ${{ inputs.sonar_args }}

      - name: Snyk Open Source scan
        if: ${{ inputs.run_snyk && env.SNYK_TOKEN != '' }}
        uses: snyk/actions/python@master
        with:
          args: ${{ inputs.snyk_args }}
